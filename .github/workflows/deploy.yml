name: Build and Deploy to Hostinger

on:
  push:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸšš Get latest code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ“ Create Production .env
        run: |
          echo "PRISMA_CLIENT_ENGINE_TYPE=library" > .env
          echo 'DATABASE_URL="mysql://u187686201_fyddb:OrchidsAdmin2024@localhost:3306/u187686201_fydhomes_db?connection_limit=3"' >> .env
          echo "NEXT_PUBLIC_BASE_URL=https://new.fydhomes.in" >> .env
          echo "NEXTAUTH_URL=https://new.fydhomes.in" >> .env
          # Note: In a real production setup, these should be GitHub Secrets

      - name: ðŸ§¬ Generate Prisma Client
        run: npx prisma generate

      - name: ðŸ—ï¸ Build Project (Standalone)
        run: npx next build
        env:
          NEXT_PUBLIC_BASE_URL: https://new.fydhomes.in
          DATABASE_URL: "mysql://build_mock:mock@localhost:3306/build_mock"
          CI: true

      - name: ðŸ“‚ Prepare Standalone Directory
        run: |
          echo "Copying public assets..."
          cp -r public .next/standalone/public
          echo "Copying static assets..."
          mkdir -p .next/standalone/.next/static
          cp -r .next/static .next/standalone/.next/static

          # Copy .env if it exists (for runtime config)
          if [ -f .env ]; then
            cp .env .next/standalone/.env
          else
            echo "Warning: .env file not found. Ensure environment variables are set on server."
          fi

          echo "Standalone build prepared."

      - name: ðŸš€ Deploy via LFTP
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

          # Create lftp script using environment variables safely
          # We use single quotes for the mirror command to avoid shell expansion of the command itself,
          # but we need the variables to expand.
          # Actually, best practice is to put credentials in a netrc file or use env vars in the script.
          # LFTP supports opening via URL with credentials, or distinct user/pass commands.

          echo "set ssl:verify-certificate no" > lftp_script.txt
          echo "open $FTP_SERVER" >> lftp_script.txt
          echo "user $FTP_USERNAME $FTP_PASSWORD" >> lftp_script.txt
          echo "mirror -R --parallel=5 --verbose --delete .next/standalone/ /public_html/" >> lftp_script.txt
          echo "quit" >> lftp_script.txt

          # Execute
          lftp -f lftp_script.txt
