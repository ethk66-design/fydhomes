name: Build and Deploy to Hostinger

on:
  push:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: üì¶ Install Dependencies
        run: npm ci

      - name: üß¨ Generate Prisma Client
        # We need the client to build the app
        run: npx prisma generate

      - name: üèóÔ∏è Build Project
        # Custom build command to skip 'prisma db push' which requires live DB
        run: npx next build
        env:
          # Next.js needs these to know how to build, even if they aren't used at runtime
          NEXT_PUBLIC_BASE_URL: https://new.fydhomes.in
          # Dummy URL to satisfy Prisma Schema validation during build
          # We don't verify connection during build time for dynamic pages
          DATABASE_URL: "mysql://build_mock:mock@localhost:3306/build_mock"
          CI: true

      - name: üìÇ Sync files (FTP)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          # Protocol needs to be explicitly insecure for some shared hosts if FTPS fails,
          # but normally try secure first. Hostinger supports FTPS.
          protocol: ftps
          # Increase timeout to 5 minutes (300000ms) to handle slow connections
          timeout: 300000
          # What to upload
          local-dir: ./
          # Where to upload (usually public_html/ or just / for the root of the FTP user)
          server-dir: public_html/
          # Reset sync state with new name to fix corruption
          state-name: .ftp-deploy-sync-state-v2.json
          # Enable verbose logging for debugging
          log-level: verbose
          # Do not delete these files on the server (User uploads, env, etc)
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.next/cache/**
            **/src/**
            **/scripts/**
            **/prisma/**
            # .env  <-- Commented out to upload env vars to production
            .env.local
            README.md
            tsconfigs.json
            tailwind.config.ts
            postcss.config.js
            eslint.config.mjs
            components.json
            task.md
            *.sql
            *.log
