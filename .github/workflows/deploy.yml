name: Build and Deploy (Zip Speed Mode)

on:
  push:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸšš Get latest code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ“ Create Production .env
        run: |
          echo "PRISMA_CLIENT_ENGINE_TYPE=library" > .env
          echo 'DATABASE_URL="mysql://u187686201_fyddb:OrchidsAdmin2024@localhost:3306/u187686201_fydhomes_db?connection_limit=3"' >> .env
          echo "NEXT_PUBLIC_BASE_URL=https://new.fydhomes.in" >> .env
          echo "NEXTAUTH_URL=https://new.fydhomes.in" >> .env

      - name: ğŸ§¬ Generate Prisma Client
        run: npx prisma generate

      - name: ğŸ—ï¸ Build Project (Standalone)
        run: npx next build
        env:
          NEXT_PUBLIC_BASE_URL: https://new.fydhomes.in
          DATABASE_URL: "mysql://build_mock:mock@localhost:3306/build_mock"
          CI: true

      - name: ğŸ“¦ Zip Standalone Build
        run: |
          # Prepare standalone directory
          cp -r public .next/standalone/public
          mkdir -p .next/standalone/.next/static
          cp -r .next/static .next/standalone/.next/static
          if [ -f .env ]; then cp .env .next/standalone/.env; fi

          # Zip it up!
          cd .next/standalone
          zip -r ../../deployment.zip .
          cd ../..

          # Prepare Staging Folder for Upload
          mkdir upload_stage
          mv deployment.zip upload_stage/
          cp scripts/unzip_helper.php upload_stage/
          ls -lh upload_stage/

      - name: ğŸ“¤ Upload Build Artifact (Manual Fallback)
        uses: actions/upload-artifact@v4
        with:
          name: hostinger-build-zip
          path: upload_stage/deployment.zip
          retention-days: 1

      - name: ğŸš€ Upload Zip & Helper (SamKirkland Action)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          local-dir: ./upload_stage/
          server-dir: /public_html/
          log-level: verbose

      - name: ğŸ”“ Trigger Unzip on Server
        run: |
          echo "Triggering PHP Unzipper..."
          # This hits the PHP file on the server to unzip locally
          curl --fail -L https://new.fydhomes.in/unzip_helper.php || exit 1
          echo "Unzip triggered."
