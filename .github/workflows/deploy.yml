name: Build and Deploy to Hostinger

on:
  push:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: üì¶ Install Dependencies
        run: npm ci

      - name: üß¨ Generate Prisma Client
        # We need the client to build the app
        run: npx prisma generate

      - name: üèóÔ∏è Build Project
        # Custom build command to skip 'prisma db push' which requires live DB
        run: npx next build
        env:
          # Next.js needs these to know how to build, even if they aren't used at runtime
          NEXT_PUBLIC_BASE_URL: https://new.fydhomes.in
          # Dummy URL to satisfy Prisma Schema validation during build
          # We don't verify connection during build time for dynamic pages
          DATABASE_URL: "mysql://build_mock:mock@localhost:3306/build_mock"
          CI: true

      - name: üìù Create Deploy Version File
        run: |
          echo "Deployed: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" > public/deploy-version.txt
          echo "Commit: ${{ github.sha }}" >> public/deploy-version.txt
          echo "Branch: ${{ github.ref_name }}" >> public/deploy-version.txt

      - name: üìÇ Sync files (FTP)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          # Protocol needs to be explicitly insecure for some shared hosts if FTPS fails,
          # but normally try secure first. Hostinger supports FTPS.
          protocol: ftps
          # What to upload
          local-dir: ./
          # Where to upload - use current directory with trailing slash (required)
          server-dir: ./
          # Reset sync state with new name to fix corruption
          state-name: .ftp-deploy-sync-state-v3.json
          # Enable verbose logging for debugging
          log-level: verbose
          # Do not delete these files on the server (User uploads, env, etc)
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.next/cache/**
            **/.next/diagnostics/**
            **/public/uploads/**
            **/src/**
            **/scripts/**
            **/prisma/**
            .env
            .env.local
            README.md
            tsconfigs.json
            tailwind.config.ts
            postcss.config.js
            eslint.config.mjs
            components.json
            task.md
            *.sql
            *.log

      - name: ‚ö†Ô∏è Reminder - Restart Node.js
        run: |
          echo "=============================================="
          echo "‚ö†Ô∏è  IMPORTANT: Deployment Complete!"
          echo "=============================================="
          echo ""
          echo "If the site doesn't update, manually restart Node.js:"
          echo "  1. Go to Hostinger hPanel ‚Üí Advanced ‚Üí Node.js"
          echo "  2. Click 'Restart' button"
          echo ""
          echo "Verify deployment: https://new.fydhomes.in/deploy-version.txt"
          echo "=============================================="
