name: Build and Deploy (Zip Speed Mode)

on:
  push:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸšš Get latest code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ“ Create Production .env
        run: |
          echo "PRISMA_CLIENT_ENGINE_TYPE=library" > .env
          echo 'DATABASE_URL="mysql://u187686201_fyddb:OrchidsAdmin2024@localhost:3306/u187686201_fydhomes_db?connection_limit=3"' >> .env
          echo "NEXT_PUBLIC_BASE_URL=https://new.fydhomes.in" >> .env
          echo "NEXTAUTH_URL=https://new.fydhomes.in" >> .env

      - name: ðŸ§¬ Generate Prisma Client
        run: npx prisma generate

      - name: ðŸ—ï¸ Build Project (Standalone)
        run: npx next build
        env:
          NEXT_PUBLIC_BASE_URL: https://new.fydhomes.in
          DATABASE_URL: "mysql://build_mock:mock@localhost:3306/build_mock"
          CI: true

      - name: ðŸ“¦ Zip Standalone Build
        run: |
          # Prepare standalone directory
          cp -r public .next/standalone/public
          mkdir -p .next/standalone/.next/static
          cp -r .next/static .next/standalone/.next/static
          if [ -f .env ]; then cp .env .next/standalone/.env; fi

          # Zip it up!
          cd .next/standalone
          zip -r ../../deployment.zip .
          cd ../..
          ls -lh deployment.zip

      - name: ðŸš€ Upload Zip & Helper via LFTP
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

          # Setup .netrc for robust authentication
          # Use printf to handle potential special chars in password better than echo
          printf "machine %s login %s password %s\n" "$FTP_SERVER" "$FTP_USERNAME" "$FTP_PASSWORD" > ~/.netrc
          chmod 600 ~/.netrc

          # Lftp script
          printf "set ssl:verify-certificate no\n" > lftp_script.txt
          printf "set net:timeout 20\n" >> lftp_script.txt
          printf "set net:max-retries 2\n" >> lftp_script.txt
          printf "debug 3\n" >> lftp_script.txt
          printf "open %s\n" "$FTP_SERVER" >> lftp_script.txt
          # No user command needed, uses .netrc
          printf "put deployment.zip -o /public_html/deployment.zip\n" >> lftp_script.txt
          printf "put scripts/unzip_helper.php -o /public_html/unzip_helper.php\n" >> lftp_script.txt
          printf "quit\n" >> lftp_script.txt

          lftp -f lftp_script.txt

      - name: ðŸ”“ Trigger Unzip on Server
        run: |
          echo "Triggering PHP Unzipper..."
          # This hits the PHP file on the server to unzip locally
          curl --fail -L https://new.fydhomes.in/unzip_helper.php || exit 1
          echo "Unzip triggered."
